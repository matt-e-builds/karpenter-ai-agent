name: CI

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest

      - name: Run pytest
        run: pytest

      - name: Run evaluator guardrails
        run: pytest -q tests/test_rag.py tests/test_evaluator.py tests/test_explanation_flow.py

      - name: Log evaluation metrics sample
        run: |
          PYTHONPATH=.:src python - <<'PY'
          from pathlib import Path
          from karpenter_ai_agent.models import AnalysisInput
          from karpenter_ai_agent.orchestration.graph import run_analysis_graph

          fixture = Path("tests/fixtures/basic-karpenter.yaml").read_text()
          report = run_analysis_graph(
              AnalysisInput(
                  yaml_text=fixture,
                  region="us-east-1",
                  options={"enable_explanations": True, "enable_evaluator": True},
              )
          )

          print(f"evaluation_passed={report.raw.get('evaluation_passed')}")
          print(f"evaluation_retries={report.raw.get('evaluation_retries')}")
          print(f"evaluation_latency_ms={report.raw.get('evaluation_latency_ms')}")
          PY

  security:
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install pip-audit
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit

      - name: Run pip-audit
        run: pip-audit -r requirements.txt

      - name: Secret scan (TruffleHog)
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --results=verified,unknown
