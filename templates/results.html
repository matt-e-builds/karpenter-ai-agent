<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results - Karpenter Optimization Agent</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 2rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        h1 {
            color: #00d4aa;
            font-size: 1.5rem;
        }

        .back-link {
            color: #00d4aa;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border: 1px solid #00d4aa;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .back-link:hover {
            background: rgba(0, 212, 170, 0.1);
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.1rem;
            color: #fff;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .meta-info {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
        }

        .meta-label {
            font-size: 0.85rem;
            color: #888;
        }

        .meta-value {
            font-size: 1.1rem;
            color: #fff;
            font-weight: 500;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        .summary-stat {
            text-align: center;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .summary-stat-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .summary-stat-label {
            font-size: 0.85rem;
            color: #888;
            margin-top: 0.25rem;
        }

        .stat-high { color: #ff6b6b; }
        .stat-medium { color: #feca57; }
        .stat-low { color: #48dbfb; }
        .stat-success { color: #00d4aa; }

        .issue {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid;
        }

        .issue.high { border-left-color: #ff6b6b; }
        .issue.medium { border-left-color: #feca57; }
        .issue.low { border-left-color: #48dbfb; }

        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .issue-provisioner {
            font-weight: 600;
            color: #fff;
        }

        .issue-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .issue-badge.high { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
        .issue-badge.medium { background: rgba(254, 202, 87, 0.2); color: #feca57; }
        .issue-badge.low { background: rgba(72, 219, 251, 0.2); color: #48dbfb; }

        .issue-category {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 0.5rem;
        }

        .issue-message {
            color: #e0e0e0;
            margin-bottom: 0.5rem;
        }

        .issue-recommendation {
            font-size: 0.9rem;
            color: #00d4aa;
            background: rgba(0, 212, 170, 0.1);
            padding: 0.5rem;
            border-radius: 4px;
        }
        .issue-explanation {
            margin-top: 0.8rem;
            padding-top: 0.6rem;
            border-top: 1px dashed rgba(255, 255, 255, 0.08);
        }
        .issue-explanation summary {
            cursor: pointer;
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 0.4rem;
        }
        .issue-explanation p {
            color: #cbd5f5;
            font-size: 0.9rem;
            margin: 0.3rem 0 0.5rem 0;
        }
        .issue-change-title,
        .issue-docs-title {
            font-weight: 600;
            color: #e5e7eb;
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
        }
        .issue-change ul,
        .issue-docs ul {
            margin: 0 0 0.9rem 1.1rem;
            padding: 0;
            color: #cbd5f5;
            font-size: 0.9rem;
        }
        .issue-docs a {
            color: #60a5fa;
            text-decoration: none;
        }
        .issue-docs a:hover {
            text-decoration: underline;
        }

        /* Patch block */
        .issue-patch {
            margin-top: 0.75rem;
            padding: 0.75rem;
            border-radius: 6px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.4);
        }

        .issue-patch-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .issue-patch-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #9CA3AF;
        }

        .issue-patch-code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.78rem;
            line-height: 1.3;
            color: #E5E7EB;
            white-space: pre;
            overflow-x: auto;
        }

        /* Copy button */
        .copy-btn {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid rgba(148, 163, 184, 0.8);
            background: rgba(15, 23, 42, 0.9);
            color: #E5E7EB;
            cursor: pointer;
            transition: background 0.15s, color 0.15s, border-color 0.15s;
        }

        .copy-btn:hover {
            background: rgba(56, 189, 248, 0.15);
            border-color: rgba(56, 189, 248, 0.9);
        }

        .copy-btn.copied {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.9);
            color: #bbf7d0;
        }

        .provisioner-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .provisioner-name {
            font-weight: 600;
            color: #00d4aa;
            margin-bottom: 0.5rem;
        }

        .provisioner-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .provisioner-detail {
            display: flex;
            gap: 0.5rem;
        }

        .detail-label {
            color: #888;
        }

        .detail-value {
            color: #fff;
        }

        .detail-value.yes { color: #00d4aa; }
        .detail-value.no { color: #ff6b6b; }

        /* AI Analysis card â€“ same structure as others, with a teal accent */
        .ai-section {
            border-color: rgba(45, 212, 191, 0.35);
            background: rgba(15, 23, 42, 0.75);
        }

        .ai-section .card-title {
            border-bottom-color: rgba(45, 212, 191, 0.35);
            color: #5eead4;
        }

        .ai-intro {
            color: #9ca3af;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }
        .ai-grounding {
            color: #94a3b8;
            font-size: 0.85rem;
            margin-bottom: 0.6rem;
        }

        .ai-output {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #e5e7eb;
            white-space: pre-wrap; /* preserve bullets & line breaks */
        }

        .ai-output p {
            margin-bottom: 0.75rem;
        }

        .ai-output ul,
        .ai-output ol {
            margin-left: 1.25rem;
            margin-bottom: 0.75rem;
        }

        .error-box {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 8px;
            padding: 1rem;
            color: #ff6b6b;
        }

        .no-issues {
            text-align: center;
            padding: 2rem;
            color: #00d4aa;
        }

        .no-issues-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Summary header with health pill */
        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-header .card-title {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .health-pill {
            font-size: 0.8rem;
            padding: 0.25rem 0.6rem;
            border-radius: 999px;
            background: rgba(15, 118, 110, 0.15);
            border: 1px solid rgba(45, 212, 191, 0.35);
            color: #a5f3fc;
            display: inline-flex;
            align-items: baseline;
            gap: 0.15rem;
        }

        .health-pill .label {
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-size: 0.7rem;
            color: #7dd3fc;
        }

        .health-pill .health-score {
            font-weight: 600;
            color: #22c55e;
        }

        .health-pill .health-score-max {
            font-size: 0.75rem;
            color: #9ca3af;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Analysis Results</h1>
            <a href="/" class="back-link">New Analysis</a>
        </header>

        {% if error %}
        <div class="card error-box">
            <strong>Error:</strong> {{ error }}
            {% if parse_errors %}
            <ul style="margin-top: 0.5rem;">
                {% for err in parse_errors %}
                <li>{{ err }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
        {% else %}

        <div class="card">
            <h2 class="card-title">Configuration</h2>
            <div class="meta-info">
                <div class="meta-item">
                    <span class="meta-label">AWS Region</span>
                    <span class="meta-value">{{ region }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Provisioners / NodePools</span>
                    <span class="meta-value">{{ provisioners|length }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">EC2NodeClasses</span>
                    <span class="meta-value">{{ ec2_nodeclasses|length }}</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="summary-header">
                <h2 class="card-title">Summary</h2>
                <div class="health-pill"
                     title="Score from 0 to 100 based on issue severities and adoption of best practices like Spot, Graviton, and consolidation.">
                    <span class="label">Health Score</span>
                    <span class="health-score">{{ summary.health_score }}</span>
                    <span class="health-score-max">/ {{ summary.health_score_max }}</span>
                </div>
            </div>

            <div class="summary-grid">
                <div class="summary-stat">
                    <div class="summary-stat-value stat-high">{{ summary.issues_by_severity.high }}</div>
                    <div class="summary-stat-label">High Severity</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value stat-medium">{{ summary.issues_by_severity.medium }}</div>
                    <div class="summary-stat-label">Medium Severity</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value stat-low">{{ summary.issues_by_severity.low }}</div>
                    <div class="summary-stat-label">Low Severity</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value stat-success">{{ summary.optimization_status.spot_enabled }}</div>
                    <div class="summary-stat-label">Spot Enabled</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value stat-success">{{ summary.optimization_status.graviton_used }}</div>
                    <div class="summary-stat-label">Using Graviton</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value stat-success">{{ summary.optimization_status.consolidation_enabled }}</div>
                    <div class="summary-stat-label">Consolidation On</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">Provisioner / NodePool Details</h2>
            {% for provisioner in provisioners %}
            <div class="provisioner-card">
                <div class="provisioner-name">{{ provisioner.name }}</div>
                <div class="provisioner-details">
                    <div class="provisioner-detail">
                        <span class="detail-label">Kind:</span>
                        <span class="detail-value">{{ provisioner.kind }}</span>
                    </div>
                    <div class="provisioner-detail">
                        <span class="detail-label">Consolidation:</span>
                        <span class="detail-value {% if provisioner.consolidation_enabled %}yes{% elif provisioner.consolidation_enabled == false %}no{% endif %}">
                            {% if provisioner.consolidation_enabled %}Enabled{% elif provisioner.consolidation_enabled == false %}Disabled{% else %}Not Set{% endif %}
                        </span>
                    </div>
                    <div class="provisioner-detail">
                        <span class="detail-label">Spot:</span>
                        <span class="detail-value {% if provisioner.spot_allowed %}yes{% else %}no{% endif %}">
                            {% if provisioner.spot_allowed %}Enabled{% else %}Not Enabled{% endif %}
                        </span>
                    </div>
                    <div class="provisioner-detail">
                        <span class="detail-label">Graviton:</span>
                        <span class="detail-value {% if provisioner.graviton_used %}yes{% else %}no{% endif %}">
                            {% if provisioner.graviton_used %}Yes{% else %}No{% endif %}
                        </span>
                    </div>
                    <div class="provisioner-detail">
                        <span class="detail-label">TTL:</span>
                        <span class="detail-value">
                            {% if provisioner.ttl_seconds_after_empty %}{{ provisioner.ttl_seconds_after_empty }}s{% else %}Not Set{% endif %}
                        </span>
                    </div>
                    <div class="provisioner-detail">
                        <span class="detail-label">Instance Families:</span>
                        <span class="detail-value">
                            {% if provisioner.instance_families %}{{ provisioner.instance_families|join(', ') }}{% else %}Any{% endif %}
                        </span>
                    </div>
                    {% if provisioner.nodeclass_name %}
                    <div class="provisioner-detail">
                        <span class="detail-label">EC2NodeClass:</span>
                        <span class="detail-value">{{ provisioner.nodeclass_name }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="card">
            <h2 class="card-title">EC2NodeClass Details</h2>
            {% if ec2_nodeclasses %}
                {% for nc in ec2_nodeclasses %}
                <div class="provisioner-card">
                    <div class="provisioner-name">{{ nc.name }}</div>
                    <div class="provisioner-details">
                        <div class="provisioner-detail">
                            <span class="detail-label">Instance Types:</span>
                            <span class="detail-value">
                                {% if nc.instance_types %}{{ nc.instance_types|join(', ') }}{% else %}Any{% endif %}
                            </span>
                        </div>
                        <div class="provisioner-detail">
                            <span class="detail-label">AMI Selector:</span>
                            <span class="detail-value {% if nc.ami_selector_present %}yes{% else %}no{% endif %}">
                                {% if nc.ami_selector_present %}Configured{% else %}Not Set{% endif %}
                            </span>
                        </div>
                        <div class="provisioner-detail">
                            <span class="detail-label">Security Groups:</span>
                            <span class="detail-value {% if nc.security_groups_present %}yes{% else %}no{% endif %}">
                                {% if nc.security_groups_present %}Configured{% else %}Not Set{% endif %}
                            </span>
                        </div>
                        <div class="provisioner-detail">
                            <span class="detail-label">Subnets:</span>
                            <span class="detail-value {% if nc.subnets_present %}yes{% else %}no{% endif %}">
                                {% if nc.subnets_present %}Configured{% else %}Not Set{% endif %}
                            </span>
                        </div>
                        <div class="provisioner-detail">
                            <span class="detail-label">Instance Profile:</span>
                            <span class="detail-value {% if nc.instance_profile %}yes{% else %}no{% endif %}">
                                {% if nc.instance_profile %}{{ nc.instance_profile }}{% else %}Not Set{% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p style="font-size: 0.9rem; color: #888;">No EC2NodeClass resources detected in the uploaded YAML.</p>
            {% endif %}
        </div>

        <div class="card">
            <h2 class="card-title">Detected Issues ({{ issues|length }})</h2>
            <div style="margin-bottom: 1rem;">
                <a href="/download-patches" class="back-link">Download All YAML Patches</a>
            </div>
            {% if issues %}
                {% for issue in issues %}
                <div class="issue {{ issue.severity }}">
                    <div class="issue-header">
                        <span class="issue-provisioner">{{ issue.provisioner_name }}</span>
                        <span class="issue-badge {{ issue.severity }}">{{ issue.severity }}</span>
                    </div>
                    <div class="issue-category">{{ issue.category }}</div>
                    <div class="issue-message">{{ issue.message }}</div>
                    <div class="issue-recommendation">{{ issue.recommendation }}</div>

                    {% if issue.explanation and issue.explanation.why_matters %}
                    <details class="issue-explanation">
                        <summary>Why this matters</summary>
                        <p>{{ issue.explanation.why_matters }}</p>
                        {% if issue.explanation.what_to_change %}
                        <div class="issue-change">
                            <div class="issue-change-title">What to change</div>
                            <ul>
                                {% for item in issue.explanation.what_to_change %}
                                <li>{{ item }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </details>
                    {% endif %}

                    {% if issue.explanation and issue.explanation.docs %}
                    <div class="issue-docs">
                        <div class="issue-docs-title">Relevant docs</div>
                        <ul>
                            {% for doc in issue.explanation.docs %}
                            <li>
                                <a href="{{ doc.source_url }}" target="_blank" rel="noopener">
                                    {{ doc.title }}
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if issue.patch_snippet %}
                    <div class="issue-patch">
                        <div class="issue-patch-header">
                            <div class="issue-patch-label">Suggested YAML patch</div>
                            <button type="button" class="copy-btn" data-copy-target="patch">
                                Copy
                            </button>
                        </div>
                        <pre class="issue-patch-code">{{ issue.patch_snippet }}</pre>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="no-issues">
                    <div class="no-issues-icon">&#10004;</div>
                    <p>No issues detected! Your configuration looks good.</p>
                </div>
            {% endif %}
        </div>

        <div class="card ai-section">
            <h2 class="card-title">AI Analysis</h2>
            <p class="ai-intro">
                Below is an AI-generated summary of your Karpenter configuration and optimization recommendations:
            </p>
            <p class="ai-grounding">Explanations are grounded with retrieved Karpenter docs links.</p>
            <div class="ai-output">{{ ai_analysis|safe }}</div>
        </div>

        {% if parse_errors %}
        <div class="card">
            <h2 class="card-title">Parse Warnings</h2>
            <ul style="color: #feca57;">
                {% for err in parse_errors %}
                <li>{{ err }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% endif %}
    </div>

    <script>
    // Copy YAML patch to clipboard
    document.addEventListener('click', function (e) {
        if (!e.target.classList.contains('copy-btn')) return;

        const btn = e.target;
        const patchContainer = btn.closest('.issue-patch');
        if (!patchContainer) return;

        const pre = patchContainer.querySelector('.issue-patch-code');
        if (!pre) return;

        const text = pre.textContent;

        function setCopiedState() {
            const originalText = btn.textContent;
            btn.textContent = 'Copied';
            btn.classList.add('copied');
            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('copied');
            }, 1500);
        }

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(setCopiedState).catch(err => {
                console.error('Clipboard write failed', err);
            });
        } else {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                document.execCommand('copy');
                setCopiedState();
            } catch (err) {
                console.error('execCommand copy failed', err);
            }
            document.body.removeChild(textarea);
        }
    });
    </script>
</body>
</html>
